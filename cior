#!/usr/bin/env python3
"""
Telegram Bot - –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫—É—Ä—Å–∞–º–∏
API: exchangerate-api.com
"""

import os
import logging
import json
import telebot
import requests
from telebot import types
from datetime import datetime
from typing import Optional, Tuple, Dict, Any

# ========== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ì–ò–†–û–í–ê–ù–ò–Ø ==========
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ========== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
class Config:
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway
    TELEGRAM_TOKEN = os.environ.get('TELEGRAM_TOKEN', '7668248844:AAGH_9w4oM3q6mDMeDOnnVw9HVylA1mpYio')
    EXCHANGE_API_KEY = os.environ.get('EXCHANGE_API_KEY', 'bdbda3535920a8d797c565b9')
    
    # URLs API
    EXCHANGE_API_URL = f"https://v6.exchangerate-api.com/v6/{EXCHANGE_API_KEY}"
    
    # –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
    FALLBACK_RATES = {
        'USD': 1.0,
        'EUR': 0.93,
        'RUB': 90.0,
        'GBP': 0.79,
        'JPY': 148.0,
        'CNY': 7.15,
        'KZT': 450.0,
        'UAH': 37.0,
        'BYN': 3.2,
        'TRY': 32.0,
        'AED': 3.67,
        'CAD': 1.35,
        'CHF': 0.88,
        'INR': 83.0,
        'KRW': 1300.0
    }
    
    # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã
    POPULAR_CURRENCIES = ['USD', 'EUR', 'RUB', 'GBP', 'JPY', 'CNY', 'KZT', 'UAH']

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
if not Config.TELEGRAM_TOKEN:
    logger.error("TELEGRAM_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –î–æ–±–∞–≤—å—Ç–µ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Railway.")
    raise ValueError("TELEGRAM_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞
bot = telebot.TeleBot(Config.TELEGRAM_TOKEN, parse_mode='HTML')

# ========== –£–¢–ò–õ–ò–¢–´ ==========
class ExchangeAPI:
    """–ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API –æ–±–º–µ–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤"""
    
    @staticmethod
    def convert(amount: float, from_currency: str, to_currency: str) -> Dict[str, Any]:
        """
        –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤–∞–ª—é—Ç—É —á–µ—Ä–µ–∑ API
        
        Args:
            amount: –°—É–º–º–∞ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
            from_currency: –ò—Å—Ö–æ–¥–Ω–∞—è –≤–∞–ª—é—Ç–∞ (3 –±—É–∫–≤—ã)
            to_currency: –¶–µ–ª–µ–≤–∞—è –≤–∞–ª—é—Ç–∞ (3 –±—É–∫–≤—ã)
            
        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
        """
        from_currency = from_currency.upper()
        to_currency = to_currency.upper()
        
        # –ï—Å–ª–∏ –≤–∞–ª—é—Ç—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç
        if from_currency == to_currency:
            return {
                'success': True,
                'amount': amount,
                'converted': amount,
                'rate': 1.0,
                'from': from_currency,
                'to': to_currency,
                'using_api': False,
                'message': '–í–∞–ª—é—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ'
            }
        
        # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∫—É—Ä—Å
        try:
            url = f"{Config.EXCHANGE_API_URL}/pair/{from_currency}/{to_currency}"
            logger.info(f"–ó–∞–ø—Ä–æ—Å –∫ API: {url}")
            
            response = requests.get(url, timeout=10)
            data = response.json()
            
            if data.get('result') == 'success':
                rate = data['conversion_rate']
                converted = amount * rate
                
                return {
                    'success': True,
                    'amount': amount,
                    'converted': converted,
                    'rate': rate,
                    'from': from_currency,
                    'to': to_currency,
                    'using_api': True,
                    'last_update': data.get('time_last_update_utc', ''),
                    'message': f"–ö—É—Ä—Å –æ—Ç {data.get('time_last_update_utc', 'API')}"
                }
            else:
                logger.warning(f"API error: {data.get('error-type', 'Unknown')}")
                raise Exception(f"API error: {data.get('error-type', 'Unknown')}")
                
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ API: {e}")
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã
            return ExchangeAPI.fallback_convert(amount, from_currency, to_currency)
    
    @staticmethod
    def fallback_convert(amount: float, from_currency: str, to_currency: str) -> Dict[str, Any]:
        """–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã"""
        from_rate = Config.FALLBACK_RATES.get(from_currency)
        to_rate = Config.FALLBACK_RATES.get(to_currency)
        
        if from_rate and to_rate:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ USD –∫–∞–∫ –±–∞–∑–æ–≤—É—é
            amount_usd = amount / from_rate
            converted = amount_usd * to_rate
            rate = to_rate / from_rate
            
            return {
                'success': True,
                'amount': amount,
                'converted': converted,
                'rate': rate,
                'from': from_currency,
                'to': to_currency,
                'using_api': False,
                'message': '–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã (–Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ)',
                'warning': True
            }
        else:
            return {
                'success': False,
                'error': f"–í–∞–ª—é—Ç–∞ {from_currency} –∏–ª–∏ {to_currency} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è",
                'supported': list(Config.FALLBACK_RATES.keys())
            }
    
    @staticmethod
    def get_supported_currencies() -> list:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –≤–∞–ª—é—Ç"""
        try:
            url = f"{Config.EXCHANGE_API_URL}/codes"
            response = requests.get(url, timeout=5)
            data = response.json()
            
            if data.get('result') == 'success':
                return data.get('supported_codes', [])
        except:
            pass
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤
        return [[code, ""] for code in Config.FALLBACK_RATES.keys()]

# ========== –ö–õ–ê–í–ò–ê–¢–£–†–´ ==========
def create_main_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É"""
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=2)
    
    buttons = [
        'üí± USD ‚Üí RUB', 'üí± EUR ‚Üí USD',
        'üí± RUB ‚Üí USD', 'üí± EUR ‚Üí RUB',
        'üíµ USD ‚Üí KZT', 'üí∂ EUR ‚Üí KZT',
        'üìä –í—Å–µ –≤–∞–ª—é—Ç—ã', 'üÜò –ü–æ–º–æ—â—å',
        '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏', '‚ÑπÔ∏è –û –±–æ—Ç–µ'
    ]
    
    for btn in buttons:
        markup.add(types.KeyboardButton(btn))
    
    return markup

def create_currency_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–ø—É–ª—è—Ä–Ω—ã–º–∏ –≤–∞–ª—é—Ç–∞–º–∏"""
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, row_width=3)
    
    currencies = Config.POPULAR_CURRENCIES
    buttons = [types.KeyboardButton(f"üî∏ {curr}") for curr in currencies]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
    for i in range(0, len(buttons), 3):
        markup.row(*buttons[i:i+3])
    
    markup.row(types.KeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥"))
    return markup

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========
@bot.message_handler(commands=['start'])
def handle_start(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = message.from_user
    welcome_text = f"""
üëã <b>–ü—Ä–∏–≤–µ—Ç, {user.first_name}!</b>

üí± <b>–Ø ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫—É—Ä—Å–∞–º–∏</b>

üìà <b>–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 150+ –≤–∞–ª—é—Ç
‚Ä¢ –†–µ–∞–ª—å–Ω—ã–µ –±–∏—Ä–∂–µ–≤—ã–µ –∫—É—Ä—Å—ã
‚Ä¢ –ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–∞—Ä
‚Ä¢ –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–π

üìù <b>–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</b>
1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—ã:
   <code>100 USD to RUB</code>
   <code>50.5 EUR KZT</code>

2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ

3. –î–ª—è —Å–ø–∏—Å–∫–∞ –≤–∞–ª—é—Ç: /currencies

üîÑ <b>–ö—É—Ä—Å—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è:</b> –ö–∞–∂–¥—ã–π —á–∞—Å
üåê <b>–ò—Å—Ç–æ—á–Ω–∏–∫:</b> exchangerate-api.com

üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:</b>
    """
    
    bot.send_message(
        message.chat.id,
        welcome_text,
        reply_markup=create_main_keyboard()
    )

@bot.message_handler(commands=['help', '–ø–æ–º–æ—â—å'])
def handle_help(message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
    help_text = """
üÜò <b>–ü–æ–º–æ—â—å –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –±–æ—Ç–∞</b>

<b>üìã –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>
/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/currencies - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–∞–ª—é—Ç
/convert - –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é

<b>üí± –§–æ—Ä–º–∞—Ç—ã –≤–≤–æ–¥–∞:</b>
‚Ä¢ <code>100 USD to RUB</code>
‚Ä¢ <code>50.5 EUR KZT</code>
‚Ä¢ <code>1000 RUB USD</code>

<b>üéØ –ü—Ä–∏–º–µ—Ä—ã:</b>
<code>100 USD to RUB</code> - 100$ –≤ —Ä—É–±–ª–∏
<code>50 EUR to KZT</code> - 50‚Ç¨ –≤ —Ç–µ–Ω–≥–µ
<code>1000 RUB to USD</code> - 1000‚ÇΩ –≤ –¥–æ–ª–ª–∞—Ä—ã

<b>üåç –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –≤–∞–ª—é—Ç—ã:</b>
USD - –î–æ–ª–ª–∞—Ä –°–®–ê
EUR - –ï–≤—Ä–æ
RUB - –†–æ—Å—Å–∏–π—Å–∫–∏–π —Ä—É–±–ª—å
GBP - –§—É–Ω—Ç —Å—Ç–µ—Ä–ª–∏–Ω–≥–æ–≤
JPY - –Ø–ø–æ–Ω—Å–∫–∞—è –π–µ–Ω–∞
CNY - –ö–∏—Ç–∞–π—Å–∫–∏–π —é–∞–Ω—å
KZT - –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–π —Ç–µ–Ω–≥–µ
UAH - –£–∫—Ä–∞–∏–Ω—Å–∫–∞—è –≥—Ä–∏–≤–Ω–∞

<b>‚ö†Ô∏è –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–¥–æ–≤ –≤–∞–ª—é—Ç
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ (API –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)

<b>ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b>
–î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏: @–≤–∞—à_–∞–∫–∫–∞—É–Ω—Ç
    """
    
    bot.send_message(message.chat.id, help_text)

@bot.message_handler(commands=['currencies', '–≤–∞–ª—é—Ç—ã'])
def handle_currencies(message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –≤–∞–ª—é—Ç"""
    bot.send_chat_action(message.chat.id, 'typing')
    
    try:
        currencies = ExchangeAPI.get_supported_currencies()
        
        if len(currencies) > 50:
            # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            currency_text = "<b>üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã (–ø–µ—Ä–≤—ã–µ 50):</b>\n\n"
            for code, name in currencies[:50]:
                currency_text += f"‚Ä¢ <b>{code}</b> - {name}\n"
            
            currency_text += f"\n<i>... –∏ –µ—â—ë {len(currencies)-50} –≤–∞–ª—é—Ç</i>"
        else:
            currency_text = "<b>üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã:</b>\n\n"
            for code, name in currencies:
                currency_text += f"‚Ä¢ <b>{code}</b> - {name}\n"
        
        currency_text += "\n<b>üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 3-–±—É–∫–≤–µ–Ω–Ω—ã–µ –∫–æ–¥—ã –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏</b>"
        
        bot.send_message(
            message.chat.id,
            currency_text,
            reply_markup=create_currency_keyboard()
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞–ª—é—Ç: {e}")
        bot.send_message(
            message.chat.id,
            "<b>üìã –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∞–ª—é—Ç—ã:</b>\n\n" +
            "\n".join([f"‚Ä¢ {code}" for code in Config.FALLBACK_RATES.keys()]) +
            "\n\n<i>–°–ø–∏—Å–æ–∫ –ø–æ–ª–Ω—ã–π, –Ω–æ API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</i>"
        )

@bot.message_handler(commands=['convert', '–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å'])
def handle_convert_command(message):
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    bot.send_message(
        message.chat.id,
        "<b>üí± –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç</b>\n\n"
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        "<code>100 USD to RUB</code>\n\n"
        "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏üëá",
        reply_markup=create_main_keyboard()
    )

@bot.message_handler(commands=['status', '—Å—Ç–∞—Ç—É—Å'])
def handle_status(message):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –∏ API"""
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
    test_result = ExchangeAPI.convert(1, 'USD', 'EUR')
    
    status_text = f"""
<b>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</b>

<b>ü§ñ –ë–æ—Ç:</b> ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç
<b>üìÖ –ó–∞–ø—É—â–µ–Ω:</b> {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

<b>üåê API —Å—Ç–∞—Ç—É—Å:</b> {'‚úÖ –û–Ω–ª–∞–π–Ω' if test_result.get('using_api') else '‚ö†Ô∏è –û—Ñ—Ñ–ª–∞–π–Ω'}
<b>–ö—É—Ä—Å USD/EUR:</b> {test_result.get('rate', 'N/A'):.4f}

<b>üíæ –ü–∞–º—è—Ç—å:</b> –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
<b>‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> –ù–æ—Ä–º–∞–ª—å–Ω–∞—è

<b>üîë API –∫–ª—é—á:</b> {Config.EXCHANGE_API_KEY[:8]}...{Config.EXCHANGE_API_KEY[-4:]}
<b>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</b> –ö–∞–∂–¥—ã–π —á–∞—Å

<i>–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Railway.app</i>
    """
    
    bot.send_message(message.chat.id, status_text)

# ========== –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö ==========
@bot.message_handler(func=lambda msg: msg.text in ['‚Ü©Ô∏è –ù–∞–∑–∞–¥', '–ù–∞–∑–∞–¥'])
def handle_back(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥"""
    handle_start(message)

@bot.message_handler(func=lambda msg: msg.text == 'üìä –í—Å–µ –≤–∞–ª—é—Ç—ã')
def handle_all_currencies(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –í—Å–µ –≤–∞–ª—é—Ç—ã"""
    handle_currencies(message)

@bot.message_handler(func=lambda msg: msg.text == 'üÜò –ü–æ–º–æ—â—å')
def handle_help_button(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ü–æ–º–æ—â—å"""
    handle_help(message)

@bot.message_handler(func=lambda msg: msg.text == '‚ÑπÔ∏è –û –±–æ—Ç–µ')
def handle_about(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –û –±–æ—Ç–µ"""
    about_text = """
<b>‚ÑπÔ∏è –û –±–æ—Ç–µ</b>

<b>üí± –ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç</b>
–í–µ—Ä—Å–∏—è: 2.0
–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –í–∞—à–µ –ò–º—è

<b>üåê –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:</b>
‚Ä¢ exchangerate-api.com - –æ—Å–Ω–æ–≤–Ω—ã–µ –∫—É—Ä—Å—ã
‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω—ã–µ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã

<b>‚öôÔ∏è –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:</b>
‚Ä¢ Python 3.10+
‚Ä¢ pyTelegramBotAPI
‚Ä¢ exchangerate-api.com API

<b>üìä –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è 150+ –≤–∞–ª—é—Ç
‚Ä¢ –†–µ–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã —Å –±–∏—Ä–∂
‚Ä¢ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–π —á–∞—Å
‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

<b>üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</b>
‚Ä¢ API –∫–ª—é—á–∏ –∑–∞—â–∏—â–µ–Ω—ã
‚Ä¢ –ë–µ–∑ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
‚Ä¢ Open Source –∫–æ–¥

<b>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>
‚Ä¢ 99.9% –∞–ø—Ç–∞–π–º
‚Ä¢ < 1 —Å–µ–∫ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

<b>üë®‚Äçüíª –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥:</b>
github.com/–≤–∞—à-–ª–æ–≥–∏–Ω/currency-bot

<b>ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞:</b>
@–≤–∞—à_–∞–∫–∫–∞—É–Ω—Ç
    """
    bot.send_message(message.chat.id, about_text)

@bot.message_handler(func=lambda msg: msg.text == '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏')
def handle_settings(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∏"""
    settings_text = """
<b>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</b>

<b>üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</b>

1. <b>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</b> –í–∫–ª—é—á–µ–Ω—ã
2. <b>–§–æ—Ä–º–∞—Ç —á–∏—Å–µ–ª:</b> 2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π
3. <b>–Ø–∑—ã–∫:</b> –†—É—Å—Å–∫–∏–π
4. <b>–¢–µ–º–∞:</b> –°–≤–µ—Ç–ª–∞—è

<b>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:</b>
/status - –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
/currencies - –°–ø–∏—Å–æ–∫ –≤–∞–ª—é—Ç
/help - –ü–æ–º–æ—â—å

<i>–ë–æ–ª—å—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö!</i>
    """
    bot.send_message(message.chat.id, settings_text)

@bot.message_handler(func=lambda msg: 'üí±' in msg.text or 'üíµ' in msg.text or 'üí∂' in msg.text)
def handle_quick_convert_button(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–∞–ª—é—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏
        text = message.text.replace('üí± ', '').replace('üíµ ', '').replace('üí∂ ', '')
        from_cur, to_cur = text.split(' ‚Üí ')
        
        msg = bot.send_message(
            message.chat.id,
            f"<b>üí± {from_cur} ‚Üí {to_cur}</b>\n\n"
            f"–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ <b>{from_cur}</b>:"
        )
        bot.register_next_step_handler(msg, process_quick_conversion, from_cur, to_cur)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏: {e}")
        bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏")

@bot.message_handler(func=lambda msg: msg.text.startswith('üî∏ '))
def handle_currency_button(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ —Å –≤–∞–ª—é—Ç–∞–º–∏"""
    currency = message.text.replace('üî∏ ', '')
    bot.send_message(
        message.chat.id,
        f"<b>üî∏ {currency}</b>\n\n"
        f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É –≤–∞–ª—é—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
        f"<code>100 {currency} to USD</code>\n"
        f"<code>50 EUR to {currency}</code>"
    )

# ========== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò ==========
def process_quick_conversion(message, from_cur, to_cur):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—É—é –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é"""
    try:
        # –û—á–∏—â–∞–µ–º –≤–≤–æ–¥ –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –∑–∞–ø—è—Ç—ã—Ö
        amount_text = message.text.replace(',', '.').strip()
        amount = float(amount_text)
        
        if amount <= 0:
            bot.send_message(message.chat.id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0!")
            return
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
        bot.send_chat_action(message.chat.id, 'typing')
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
        result = ExchangeAPI.convert(amount, from_cur, to_cur)
        
        if result['success']:
            send_conversion_result(message, result)
        else:
            bot.send_message(
                message.chat.id,
                f"‚ùå <b>–û—à–∏–±–∫–∞:</b> {result.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}\n\n"
                f"–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–∞–ª—é—Ç—ã:\n" +
                ", ".join(result.get('supported', []))
            )
            
    except ValueError:
        bot.send_message(message.chat.id, "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: {e}")
        bot.send_message(message.chat.id, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏")

@bot.message_handler(func=lambda message: True)
def handle_text_message(message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è)"""
    try:
        text = message.text.strip()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤–≤–æ–¥–∞
        if ' to ' in text.lower() or ' –≤ ' in text.lower():
            # –§–æ—Ä–º–∞—Ç: "100 USD to RUB" –∏–ª–∏ "100 USD –≤ RUB"
            text = text.replace(' –≤ ', ' TO ').replace(' –í ', ' TO ')
            parts = text.upper().split(' TO ')
            
            if len(parts) == 2:
                # –ü–µ—Ä–≤–∞—è —á–∞—Å—Ç—å: "100 USD"
                amount_part = parts[0].strip()
                to_cur = parts[1].strip()
                
                # –†–∞–∑–¥–µ–ª—è–µ–º —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—É
                amount_words = amount_part.split()
                if len(amount_words) >= 2:
                    amount = float(amount_words[0].replace(',', '.'))
                    from_cur = amount_words[1]
                else:
                    raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")
            else:
                raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")
                
        else:
            # –§–æ—Ä–º–∞—Ç: "100 USD RUB"
            parts = text.upper().split()
            if len(parts) == 3:
                amount = float(parts[0].replace(',', '.'))
                from_cur = parts[1]
                to_cur = parts[2]
            else:
                raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É–º–º—É
        if amount <= 0:
            bot.send_message(message.chat.id, "‚ùå –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª—å—à–µ 0!")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥—ã –≤–∞–ª—é—Ç
        if len(from_cur) != 3 or len(to_cur) != 3:
            bot.send_message(
                message.chat.id,
                "‚ùå –ö–æ–¥—ã –≤–∞–ª—é—Ç –¥–æ–ª–∂–Ω—ã —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 3 –±—É–∫–≤!\n"
                "–ü—Ä–∏–º–µ—Ä: USD, EUR, RUB"
            )
            return
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
        bot.send_chat_action(message.chat.id, 'typing')
        
        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
        result = ExchangeAPI.convert(amount, from_cur, to_cur)
        
        if result['success']:
            send_conversion_result(message, result)
        else:
            bot.send_message(
                message.chat.id,
                f"‚ùå <b>–û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏:</b>\n{result.get('error', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}\n\n"
                f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /currencies –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤–∞–ª—é—Ç"
            )
            
    except ValueError as e:
        logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞: {message.text}")
        error_text = """
‚ùå <b>–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!</b>

<b>üìù –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</b>
‚Ä¢ <code>100 USD to RUB</code>
‚Ä¢ <code>50.5 EUR KZT</code>
‚Ä¢ <code>1000 RUB USD</code>

<b>üéØ –ü—Ä–∏–º–µ—Ä—ã:</b>
<code>100 USD to RUB</code> - 100$ –≤ —Ä—É–±–ª–∏
<code>50 EUR to KZT</code> - 50‚Ç¨ –≤ —Ç–µ–Ω–≥–µ
<code>75.25 GBP EUR</code> - 75.25¬£ –≤ –µ–≤—Ä–æ

<b>üåç –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∞–ª—é—Ç—ã:</b>
USD, EUR, RUB, GBP, JPY, CNY, KZT, UAH

<b>üìã –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫:</b> /currencies
        """
        bot.send_message(message.chat.id, error_text)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        bot.send_message(
            message.chat.id,
            "‚ùå <b>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!</b>\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –≤–≤–æ–¥–∞ –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

def send_conversion_result(message, result):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏"""
    amount = result['amount']
    converted = result['converted']
    from_cur = result['from']
    to_cur = result['to']
    rate = result['rate']
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–∞
    amount_str = f"{amount:,.2f}".replace(',', ' ').replace('.', ',')
    converted_str = f"{converted:,.2f}".replace(',', ' ').replace('.', ',')
    
    # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    result_text = f"""
‚úÖ <b>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!</b>

<b>üì• –í–≤–æ–¥:</b> {amount_str} {from_cur}
<b>üì§ –í—ã–≤–æ–¥:</b> {converted_str} {to_cur}

<b>üìä –ö—É—Ä—Å:</b> 1 {from_cur} = {rate:.6f} {to_cur}
<b>üîÑ –û–±—Ä–∞—Ç–Ω–æ:</b> 1 {to_cur} = {(1/rate):.6f} {from_cur}

<b>üìà –ò—Å—Ç–æ—á–Ω–∏–∫:</b> {'Real-time API' if result.get('using_api') else 'Fixed rates'}
<b>üïí {result.get('message', '')}</b>

<i>–î–ª—è –Ω–æ–≤–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—ã</i>
    """
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã
    if result.get('warning'):
        result_text += "\n\n‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã (–Ω–µ —Ä–µ–∞–ª—å–Ω—ã–µ)"
    
    # –°–æ–∑–¥–∞–µ–º inline-–∫–Ω–æ–ø–∫—É –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
    markup = types.InlineKeyboardMarkup()
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
    reverse_btn = types.InlineKeyboardButton(
        f"üîÑ {to_cur} ‚Üí {from_cur}",
        callback_data=f"reverse_{to_cur}_{from_cur}_{converted:.2f}"
    )
    
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–æ–≤–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏
    new_convert_btn = types.InlineKeyboardButton(
        "üí± –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è",
        callback_data="new_conversion"
    )
    
    markup.row(reverse_btn)
    markup.row(new_convert_btn)
    
    bot.send_message(
        message.chat.id,
        result_text,
        reply_markup=markup
    )

# ========== INLINE –ö–ù–û–ü–ö–ò ==========
@bot.callback_query_handler(func=lambda call: True)
def handle_inline_buttons(call):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ inline-–∫–Ω–æ–ø–æ–∫"""
    try:
        if call.data.startswith('reverse_'):
            # –û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
            _, from_cur, to_cur, amount = call.data.split('_')
            amount = float(amount)
            
            bot.answer_callback_query(call.id, "üîÑ –û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è...")
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º
            result = ExchangeAPI.convert(amount, from_cur, to_cur)
            
            if result['success']:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                amount = result['amount']
                converted = result['converted']
                rate = result['rate']
                
                result_text = f"""
üîÑ <b>–û–±—Ä–∞—Ç–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è</b>

<b>üì• –í–≤–æ–¥:</b> {amount:,.2f} {from_cur}
<b>üì§ –í—ã–≤–æ–¥:</b> {converted:,.2f} {to_cur}

<b>üìä –ö—É—Ä—Å:</b> 1 {from_cur} = {rate:.6f} {to_cur}
                """
                
                bot.edit_message_text(
                    result_text,
                    chat_id=call.message.chat.id,
                    message_id=call.message.message_id,
                    parse_mode='HTML'
                )
            else:
                bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ–π –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏")
                
        elif call.data == 'new_conversion':
            # –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è
            bot.answer_callback_query(call.id, "üí± –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è")
            bot.send_message(
                call.message.chat.id,
                "<b>üí± –ù–æ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è</b>\n\n"
                "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—É–º–º—É –∏ –≤–∞–ª—é—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:\n"
                "<code>100 USD to RUB</code>",
                parse_mode='HTML'
            )
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ inline-–∫–Ω–æ–ø–∫–∏: {e}")
        bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞")

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========
if __name__ == '__main__':
    logger.info("=" * 50)
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞-–∫–æ–Ω–≤–µ—Ä—Ç–µ—Ä–∞ –≤–∞–ª—é—Ç")
    logger.info(f"ü§ñ ID –±–æ—Ç–∞: {bot.get_me().id}")
    logger.info(f"üîë API –∫–ª—é—á: {Config.EXCHANGE_API_KEY[:8]}...")
    logger.info("=" * 50)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API
    logger.info("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API...")
    try:
        test = ExchangeAPI.convert(1, 'USD', 'EUR')
        if test['success']:
            logger.info(f"‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç! –ö—É—Ä—Å USD/EUR: {test['rate']:.4f}")
            if test.get('using_api'):
                logger.info("üì° –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ–∞–ª—å–Ω—ã–π API")
            else:
                logger.warning("‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É—Ä—Å—ã")
        else:
            logger.warning(f"‚ö†Ô∏è API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: {test.get('error')}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API: {e}")
    
    logger.info("ü§ñ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    logger.info("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π...")
    logger.info("=" * 50)
    
    try:
        bot.infinity_polling(timeout=60, long_polling_timeout=60)
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞: {e}")
        raise
python bot.py
